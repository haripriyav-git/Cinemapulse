<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CinemaPulse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/movies.css') }}">
    <style>
        :root { --accent-red: #e50914; --card-bg: #1a1a1a; --text-gray: #aaa; }
        body { background-color: #0d0d0d; color: white; font-family: 'Poppins', sans-serif; margin: 0; overflow-x: hidden; }
        
        .hero-banner { 
            height: 50vh; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; background: linear-gradient(to bottom, rgba(0,0,0,0.6), #0d0d0d), 
            url('https://images.unsplash.com/photo-1478720568477-152d9b164e26?q=80&w=2070'); 
            background-size: cover; background-position: center; 
        }
        .hero-banner h1 span { color: var(--accent-red); }
        .main-content { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .section-header { border-left: 4px solid var(--accent-red); padding-left: 15px; margin-bottom: 30px; }

        /* Audience Pulse Graph Styling */
        .pulse-container { 
            background: #121212; border-radius: 12px; border: 1px solid #333; 
            margin-bottom: 40px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .pulse-header { padding: 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .vibe-tag-display { background: rgba(229, 9, 20, 0.1); color: var(--accent-red); padding: 6px 16px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; transition: 0.3s; }
        
        .vibe-legend-card {
            background: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid #333;
            margin-bottom: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .legend-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .legend-item { display: flex; align-items: flex-start; gap: 12px; }
        .legend-content { display: flex; flex-direction: column; }
        .legend-content strong { font-size: 0.95rem; color: #fff; }
        .vibe-desc { font-size: 0.8rem; color: var(--text-gray); }

        .mood-discovery { margin-bottom: 40px; padding: 25px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid #222; }
        .vibe-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: var(--accent-red); font-weight: bold; display: block; margin-bottom: 15px; }
        .mood-options { display: flex; gap: 10px; flex-wrap: wrap; }
        .mood-btn { 
            background: #222; border: 1px solid #444; color: #fff; padding: 10px 20px; 
            border-radius: 30px; cursor: pointer; display: flex; align-items: center; gap: 10px; 
            font-size: 0.85rem; transition: 0.3s ease; 
        }
        .mood-btn:hover { border-color: var(--accent-red); background: #2a2a2a; transform: translateY(-2px); }
        .mood-btn.active { background: var(--accent-red); border-color: var(--accent-red); box-shadow: 0 0 15px rgba(229, 9, 20, 0.4); }
        .mood-btn.reset { color: #fff; border: 1px dashed #555; }

        .placeholder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 30px; }
        .movie-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid #222; transition: 0.3s ease; }
        .movie-card:hover { border-color: var(--accent-red); transform: translateY(-10px); }
        .poster-box { position: relative; height: 320px; cursor: pointer; }
        .bg-poster { width: 100%; height: 100%; object-fit: cover; }
        .rank-badge { position: absolute; top: 10px; left: 10px; background: var(--accent-red); padding: 5px 12px; border-radius: 5px; font-weight: bold; }
        
        .movie-info { padding: 15px; }
        .movie-desc-short { 
            font-size: 0.85rem; color: #888; margin: 10px 0; 
            display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; 
        }

        .movie-badges { display: flex; gap: 8px; margin: 8px 0; }
        .badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; background: rgba(255, 255, 255, 0.1); color: var(--accent-red); border: 1px solid rgba(229, 9, 20, 0.3); text-transform: uppercase; }

        .read-more-link { color: var(--accent-red); cursor: pointer; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; }

        .dot { height: 12px; width: 12px; border-radius: 50%; flex-shrink: 0; }
        .mind-blowing, .vibe-Mind-Blowing { background: #e50914; }
        .heartwarming, .vibe-Heartwarming { background: #ff69b4; }
        .tear-jerker, .vibe-Tear-Jerker { background: #3498db; }
        .edge-seat, .vibe-Edge-of-Seat { background: #f1c40f; }
        .pure-joy, .vibe-Pure-Joy { background: #2ecc71; }
        .thought-provoking, .vibe-Thought-Provoking { background: #9b59b6; }

        .vibe-meter-container { background: #333; height: 8px; width: 100%; border-radius: 4px; margin-top: 10px; overflow: hidden; display: flex; }
        .vibe-segment { height: 100%; transition: width 0.5s ease; width: var(--width, 0%); }

        .feedback-feed { margin-top: 60px; background: #111; padding: 25px; border-radius: 12px; border: 1px solid #222; }
        .feed-item { border-bottom: 1px solid #222; padding: 15px 0; }
        .vibe-tag { color: var(--accent-red); font-weight: bold; background: rgba(229, 9, 20, 0.1); padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); }
        .modal-content { background: var(--card-bg); margin: 8% auto; padding: 30px; width: 90%; max-width: 500px; border-radius: 12px; border: 1px solid #333; }
        .close-btn { background: #444; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; margin-top: 15px; width: 100%; }
        .submit-btn { background: var(--accent-red); color: white; border: none; padding: 12px; cursor: pointer; border-radius: 5px; width: 100%; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="hero-banner">
        <h1>Welcome to your Cinema<span>Pulse</span></h1>
        <p>Your unique emotional guide to the world of movies.</p>
    </div>

    <div class="main-content" style="padding-top: 0;">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for message in messages %}
              <div style="background: #2ecc71; color: white; padding: 15px; border-radius: 8px; margin-bottom: 30px; text-align: center; font-weight: bold; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

<div class="dashboard-wrapper">
    <div class="pulse-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <span class="blink-dot"></span>
            <span style="font-size: 0.75rem; letter-spacing: 1px; color: #888; font-weight: bold;">LIVE PULSE ANALYSIS</span>
            <h2 style="margin: 5px 0;">CinemaPulse Dashboard</h2>
        </div>
        <div style="display:flex; gap: 10px;">
            <select id="movieSelect1" onchange="initPulseDashboard()" style="background:#222; color:white; border:1px solid #444; padding:8px; border-radius:5px;">
                {% for movie in movies %}<option value="{{ movie.title }}">{{ movie.title }}</option>{% endfor %}
            </select>
            <select id="movieSelect2" onchange="initPulseDashboard()" style="background:#222; color:white; border:1px solid #444; padding:8px; border-radius:5px;">
                <option value="">Compare with...</option>
                {% for movie in movies %}<option value="{{ movie.title }}">{{ movie.title }}</option>{% endfor %}
            </select>
        </div>
    </div>

    <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
        <div class="metric-card" style="background:#1a1a1a; padding:20px; border-radius:12px; border-top: 4px solid #e50914;">
            <small style="color:#888; font-weight:bold;">TOTAL PULSE</small>
            <h2 id="total-reviews-count" style="margin:10px 0 0;">0</h2>
        </div>
        <div class="metric-card" style="background:#1a1a1a; padding:20px; border-radius:12px; border-top: 4px solid #2ecc71;">
            <small style="color:#888; font-weight:bold;">PEAK RESONANCE</small>
            <h2 id="top-vibe-name" style="margin:10px 0 0; font-size: 1.2rem; color: #2ecc71;">--</h2>
        </div>
        <div class="metric-card" style="background:#1a1a1a; padding:20px; border-radius:12px; border-top: 4px solid #3498db;">
            <small style="color:#888; font-weight:bold;">ENGAGEMENT</small>
            <h2 style="margin:10px 0 0; color: #3498db;">ACTIVE</h2>
        </div>
    </div>

    <div class="chart-container" style="background: #050505; border-radius: 15px; border: 1px solid #333; height: 400px; padding: 20px; margin-bottom: 25px;">
        <canvas id="pulsePolarChart"></canvas>
    </div>

    <div id="pulseDescription" style="padding: 20px; background: #111; border-left: 4px solid #e50914; border-radius: 8px; color: #ccc; font-size: 0.95rem; line-height: 1.6;">
        Initializing real-time community heartbeat...
    </div>
</div>

    <div class="vibe-legend-card">
        <div class="legend-header">
            <h3>What is a Cinema<span>Pulse</span>?</h3>
            <p>Each color represents a unique emotional "pulse":</p>
        </div>
            <div class="legend-grid">
                <div class="legend-item"><span class="dot mind-blowing"></span><strong>Mind-Blowing</strong></div>
                <div class="legend-item"><span class="dot heartwarming"></span><strong>Heartwarming</strong></div>
                <div class="legend-item"><span class="dot tear-jerker"></span><strong>Tear-Jerker</strong></div>
                <div class="legend-item"><span class="dot edge-seat"></span><strong>Edge-of-Seat</strong></div>
                <div class="legend-item"><span class="dot pure-joy"></span><strong>Pure Joy</strong></div>
                <div class="legend-item"><span class="dot thought-provoking"></span><strong>Thought-Provoking</strong></div>
            </div>
        </div>

        <div class="mood-discovery">
            <span class="vibe-label">Filter by Atmosphere</span>
            <div class="mood-options">
                <button class="mood-btn" onclick="filterVibe('Mind-Blowing', this)"><span class="dot mind-blowing"></span> Mind-Blowing</button>
                <button class="mood-btn" onclick="filterVibe('Heartwarming', this)"><span class="dot heartwarming"></span> Heartwarming</button>
                <button class="mood-btn" onclick="filterVibe('Tear-Jerker', this)"><span class="dot tear-jerker"></span> Tear-Jerker</button>
                <button class="mood-btn" onclick="filterVibe('Edge-of-Seat', this)"><span class="dot edge-seat"></span> Edge-of-Seat</button>
                <button class="mood-btn" onclick="filterVibe('Pure-Joy', this)"><span class="dot pure-joy"></span> Pure Joy</button>
                <button class="mood-btn" onclick="filterVibe('Thought-Provoking', this)"><span class="dot thought-provoking"></span> Thought-Provoking</button>
                <button class="mood-btn reset active" onclick="filterVibe('all', this)">View All</button>
            </div>
        </div>

        <div class="section-header">
            <h2>Trending <span style="font-weight: 300;">Pulses</span></h2>
        </div>

        <div class="placeholder-grid" id="movieGrid">
            {% for movie in movies %}
            <div class="movie-card" data-vibes="{% if movie_stats.get(movie.title) %}{% for v in movie_stats[movie.title].keys() %}{{ v }} {% endfor %}{% endif %}">
                <div class="poster-box" onclick="openFeedback('{{ movie.title }}')">
                    <img src="{{ movie.img }}" class="bg-poster" alt="{{ movie.title }}" loading="lazy">
                    <div class="rank-badge">#{{ movie.rank }}</div>
                </div>

                <div class="movie-info">
                    <h3>{{ movie.title }}</h3>
                    <div class="details">{{ movie.year }} ‚Ä¢ ‚≠ê {{ movie.rating }}</div>
                    <div class="movie-badges">
                        <span class="badge">{{ movie.lang }}</span>
                        <span class="badge">{{ movie.genre }}</span>
                    </div>
                    <p class="movie-desc-short">{{ movie.desc }}</p>
                    <span class="read-more-link" data-title="{{ movie.title }}" data-desc="{{ movie.desc }}" onclick="openDescModalFromData(this)">Read More</span>

                    <div style="font-size: 0.65rem; color: var(--text-gray); margin-top: 12px; text-transform: uppercase;">Community Pulse</div>
                    <div class="vibe-meter-container">
                        {% if movie_stats and movie_stats.get(movie.title) %}
                            {% for vibe_name, percent in movie_stats[movie.title].items() %}
                                <div class="vibe-segment vibe-{{ vibe_name.replace(' ', '-') }}"
                                     style="--width: {{ percent|int }}%;">
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="width: 100%; background: #222;"></div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="feedback-feed">
            <h3 style="border-bottom: 1px solid var(--accent-red); padding-bottom: 10px; margin-bottom: 20px;">Live Community Feed</h3>
            <div class="community-feed-container" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                {% if feedbacks %}
                    {% for entry in feedbacks|reverse %}
                    <div class="feed-item">
                        <small>
                            <strong>{{ entry.user_name }}</strong> felt 
                            <span class="vibe-tag">
                                {{ entry.vibe }}
                                {% if entry.vibe == 'Mind-Blowing' %} ü§Ø
                                {% elif entry.vibe == 'Heartwarming' %} ‚ù§Ô∏è
                                {% elif entry.vibe == 'Tear-Jerker' %} üò¢
                                {% elif entry.vibe == 'Edge-of-Seat' %} ‚ö°
                                {% elif entry.vibe == 'Pure-Joy' %} üòä
                                {% elif entry.vibe == 'Thought-Provoking' %} ü§î
                                {% endif %}
                            </span> about 
                            <em>{{ entry.movie_title }}</em>
                        </small>
                        <p style="color: var(--text-gray); margin: 5px 0 0 0; font-size: 0.85rem;">"{{ entry.comment|truncate(80) }}"</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--text-gray);">No pulses recorded yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="descModal" class="modal">
        <div class="modal-content">
            <h2 id="descModalTitle" style="color: var(--accent-red); margin-top: 0;"></h2>
            <p id="descModalText" style="line-height: 1.6; color: #ccc; font-size: 1rem;"></p>
            <button class="close-btn" onclick="closeDescModal()">Close</button>
        </div>
    </div>

    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <h2 id="modalMovieTitle" style="margin-top: 0; color: var(--accent-red);"></h2>
            <form action="{{ url_for('submit_feedback') }}" method="POST">
                <input type="hidden" name="movie_title" id="hiddenMovieTitle">
                <label style="color:#aaa; font-size: 0.8rem; display: block; margin-bottom: 5px;">Score (1-10)</label>
                <input type="number" name="rating" min="1" max="10" value="10" style="width:100%; padding:10px; background:#222; color:white; border:1px solid #444; margin-bottom:15px; border-radius: 5px;">
                <label style="color:#aaa; font-size: 0.8rem; display: block; margin-bottom: 5px;">Vibe</label>
                <select name="vibe" required style="width:100%; padding:10px; background:#222; color:white; border:1px solid #444; margin-bottom:15px; border-radius: 5px;">
                    <option value="Mind-Blowing">Mind-Blowing ü§Ø</option>
                    <option value="Heartwarming">Heartwarming ‚ù§Ô∏è</option>
                    <option value="Tear-Jerker">Tear-Jerker üò¢</option>
                    <option value="Edge-of-Seat">Edge-of-Seat ‚ö°</option>
                    <option value="Pure-Joy">Pure Joy üòä</option>
                    <option value="Thought-Provoking">Thought-Provoking ü§î</option>
                </select>
                <textarea name="comment" rows="3" placeholder="Tell us more..." required style="width:100%; padding:10px; background:#222; color:white; border:1px solid #444; border-radius: 5px;"></textarea>
                <button type="submit" class="submit-btn">Post Pulse</button>
                <button type="button" class="close-btn" onclick="closeFeedback()" style="background: #333;">Cancel</button>
            </form>

        </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global Constants
    const vibeColors = ['#e50914', '#ff69b4', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6'];
    const labels = ['Mind-Blowing', 'Heartwarming', 'Tear-Jerker', 'Edge-of-Seat', 'Pure Joy', 'Thought-Provoking'];

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the polar chart on page load
        setTimeout(initPulseDashboard, 200);
        // Refresh data every 30 seconds for the "Live" feel
        setInterval(initPulseDashboard, 30000);
    });

    async function initPulseDashboard() {
        const m1Select = document.getElementById('movieSelect1');
        const m2Select = document.getElementById('movieSelect2');
        
        if (!m1Select) return; // Guard against missing elements

        const m1 = m1Select.value;
        const m2 = m2Select ? m2Select.value : "";

        try {
            const response = await fetch(`/api/radar-comparison?m1=${encodeURIComponent(m1)}&m2=${encodeURIComponent(m2)}`);
            const result = await response.json();
            
            const canvas = document.getElementById('pulsePolarChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            const existing = Chart.getChart("pulsePolarChart");
            if (existing) existing.destroy();

            new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: labels,
                    datasets: result.datasets.map((ds, i) => ({
                        label: ds.label,
                        data: ds.data,
                        backgroundColor: i === 0 ? vibeColors.map(c => c + 'aa') : 'rgba(255,255,255,0.1)',
                        borderColor: '#111',
                        borderWidth: 2
                    }))
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { 
                        r: { 
                            grid: { color: '#222' }, 
                            ticks: { display: false },
                            angleLines: { color: '#333' }
                        } 
                    },
                    plugins: { 
                        legend: { 
                            position: 'right', 
                            labels: { color: '#888', font: { family: 'Poppins', size: 11 } } 
                        } 
                    }
                }
            });

            // Update Metrics and Conclusion text
            updateRealTimeAnalysis(result, m1, m2);
        } catch (e) { 
            console.error("Dashboard Sync Error:", e); 
            const desc = document.getElementById('pulseDescription');
            if (desc) desc.innerText = "Offline: Unable to sync with live pulse.";
        }
    }

    function updateRealTimeAnalysis(result, m1, m2) {
        if (!result.datasets || result.datasets.length === 0) return;

        const data1 = result.datasets[0].data;
        const total = data1.reduce((a, b) => a + b, 0);
        const peakIdx = data1.indexOf(Math.max(...data1));
        
        // Update Stats Cards
        const totalElem = document.getElementById('total-reviews-count');
        const vibeElem = document.getElementById('top-vibe-name');
        const descElem = document.getElementById('pulseDescription');

        if (totalElem) totalElem.innerText = total;
        if (vibeElem) {
            vibeElem.innerText = total > 0 ? labels[peakIdx] : "--";
            vibeElem.style.color = total > 0 ? vibeColors[peakIdx] : "#2ecc71";
        }
        
        // Real-Time Inference Logic
        if (descElem) {
            if (total > 0) {
                let conclusion = `<strong>Real-Time Movie Conclusion:</strong> <em>${m1}</em> is currently peaking with a <span style="color:${vibeColors[peakIdx]}"><strong>${labels[peakIdx]}</strong></span> resonance. `;
                conclusion += `Viewers can infer a high emotional intensity in this category, suggesting the film's core impact is driven by its ability to be ${labels[peakIdx].toLowerCase()}.`;
                
                if (m2 && result.datasets[1]) {
                    const d2 = result.datasets[1].data;
                    const peak2 = d2.indexOf(Math.max(...d2));
                    conclusion += `<br><br>Comparatively, <em>${m2}</em> leans toward a <strong>${labels[peak2]}</strong> vibe, highlighting a distinct emotional divergence between the two titles.`;
                }
                descElem.innerHTML = conclusion;
            } else {
                descElem.innerText = "No pulses recorded yet for the selected titles.";
            }
        }
    }

    // Modal & UI Functions
    function openReadMore(title, desc) {
        const mTitle = document.getElementById('modalTitle');
        const mDesc = document.getElementById('modalDescription');
        if (mTitle) mTitle.innerText = title;
        if (mDesc) mDesc.innerText = desc;
        const modal = document.getElementById('readMoreModal');
        if (modal) modal.style.display = 'block';
    }

    function openDescModalFromData(element) {
        document.getElementById('descModalTitle').innerText = element.getAttribute('data-title');
        document.getElementById('descModalText').innerText = element.getAttribute('data-desc');
        document.getElementById('descModal').style.display = 'block';
    }
    
    function closeDescModal() { 
        document.getElementById('descModal').style.display = 'none'; 
    }
    
    function openFeedback(title) {
        document.getElementById('modalMovieTitle').innerText = "Pulse: " + title;
        document.getElementById('hiddenMovieTitle').value = title;
        document.getElementById('feedbackModal').style.display = 'block';
    }
    
    function closeFeedback() { 
        document.getElementById('feedbackModal').style.display = 'none'; 
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.style.display = 'none';
    }
    
    function filterVibe(vibe, btn) {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.movie-card').forEach(card => {
            const cardVibes = card.getAttribute('data-vibes');
            if (vibe === 'all') card.style.display = 'block';
            else card.style.display = cardVibes && cardVibes.includes(vibe) ? 'block' : 'none';
        });
    }
</script>
<footer style="text-align: center; padding: 40px 20px; color: #444; font-size: 0.8rem; border-top: 1px solid #222; margin-top: 50px; line-height: 1.6;">
    <p style="margin-bottom: 5px;">&copy; 2026 <strong>CinemaPulse</strong>. All Rights Reserved.</p>
    <p style="margin-top: 0;">
        Designed and Developed by <span style="color: #888;">Cinemapulse org</span> | 
      </p>
    </footer>
</body>
</html>