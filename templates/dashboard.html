<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CinemaPulse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/movies.css') }}">
    <style>
        :root { --accent-red: #e50914; --card-bg: #1a1a1a; --text-gray: #aaa; }
        body { background-color: #0d0d0d; color: white; font-family: 'Poppins', sans-serif; margin: 0; overflow-x: hidden; }
        
        .hero-banner { 
            height: 25vh; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; background: linear-gradient(to bottom, rgba(0,0,0,0.7), #0d0d0d), 
            url('https://images.unsplash.com/photo-1478720568477-152d9b164e26?q=80&w=2070'); 
            background-size: cover; background-position: center; 
        }
        .hero-banner h1 span { color: var(--accent-red); }
        .main-content { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Metrics */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; border: 1px solid #222; border-top: 4px solid var(--accent-red); }

        /* Movie Grid */
        .placeholder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; }
        .movie-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid #222; display: flex; flex-direction: column; height: 100%; transition: 0.3s; position: relative; }
        .poster-box { height: 320px; position: relative; cursor: pointer; }
        .bg-poster { width: 100%; height: 100%; object-fit: cover; }
        
        .movie-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .movie-info h3 { font-size: 1rem; margin: 0 0 8px; min-height: 2.4em; }
        
        .info-badges { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 4px; background: rgba(255, 255, 255, 0.05); color: var(--accent-red); border: 1px solid rgba(229, 9, 20, 0.3); text-transform: uppercase; font-weight: bold; }

        .vibe-meter-container { background: #222; height: 6px; width: 100%; border-radius: 3px; overflow: hidden; display: flex; margin-top: auto; }
        .vibe-segment { height: 100%; width: var(--width, 0%); }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .modal-content { background: #181818; margin: 8% auto; padding: 25px; width: 90%; max-width: 600px; border-radius: 15px; border: 1px solid #333; }
        .form-input { width: 100%; padding: 10px; background: #252525; color: white; border: 1px solid #333; border-radius: 6px; margin-bottom: 12px; box-sizing: border-box; font-family: inherit; }

        /* Vibe Colors */
        .vibe-Mind-Blowing { background: #e50914; }
        .vibe-Heartwarming { background: #ff69b4; }
        .vibe-Tear-Jerker { background: #3498db; }
        .vibe-Edge-of-Seat { background: #f1c40f; }
        .vibe-Pure-Joy { background: #2ecc71; }
        .vibe-Thought-Provoking { background: #9b59b6; }

        @keyframes pulse-live { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        footer { text-align: center; padding: 40px 20px; color: #444; font-size: 0.8rem; border-top: 1px solid #222; margin-top: 60px; }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="hero-banner">
        <h1>Cinema<span>Pulse</span> Dashboard</h1>
    </div>
     <div class="main-content" style="padding-top: 0;">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for message in messages %}
              <div style="background: #2ecc71; color: white; padding: 15px; border-radius: 8px; margin-bottom: 30px; text-align: center; font-weight: bold; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

    <div class="main-content">
        <div class="metrics-grid">
            <div class="metric-card">
                <small>TOP MOVIE</small>
                <h4 style="margin: 5px 0 0; color: var(--accent-red);">{{ top_movie }}</h4>
            </div>
            <div class="metric-card" style="border-top-color: #2ecc71;">
                <small>TRENDING VIBE</small>
                <h4 style="margin: 5px 0 0; color: #2ecc71;">{{ top_vibe }}</h4>
            </div>
            <div class="metric-card" style="border-top-color: #3498db;">
                <small>TOTAL PULSES</small>
                <h4 style="margin: 5px 0 0;">{{ feedbacks|length }}</h4>
            </div>
        </div>

        <div class="placeholder-grid" id="movieGrid">
            {% for movie in movies %}
            <div class="movie-card">
                <div class="poster-box" onclick="openAnalysisModal(this)" data-title="{{ movie.title }}" data-desc="{{ movie.desc }}">
                    <img src="{{ movie.img }}" class="bg-poster" alt="{{ movie.title }}">
                    <button onclick="event.stopPropagation(); openFeedback('{{ movie.title }}')" style="position:absolute; bottom:15px; right:15px; background:var(--accent-red); border:none; color:white; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.6);">Pulse +</button>
                </div>
                <div class="movie-info">
                    <h3>{{ movie.title }}</h3>
                    <div class="info-badges">
                        <span class="badge">{{ movie.lang }}</span>
                        <span class="badge">{{ movie.genre }}</span>
                        <span class="badge">{{ movie.year }}</span>
                    </div>
                    <div class="vibe-meter-container">
                        {% if movie_stats.get(movie.title) %}
                            {% for v_name, percent in movie_stats[movie.title].items() %}
                                <div class="vibe-segment vibe-{{ v_name.replace(' ', '-') }}" style="--width: {{ percent|int }}%;"></div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div style="margin-top: 50px; background: #111; padding: 25px; border-radius: 15px; border: 1px solid #222;">
            <h3 style="margin: 0 0 20px; color: var(--accent-red); font-size: 0.9rem; letter-spacing: 1px;">
                <span style="height: 8px; width: 8px; background: #e50914; border-radius: 50%; display:inline-block; animation: pulse-live 1.5s infinite; margin-right: 8px;"></span>LIVE COMMUNITY FEED
            </h3>
            <div style="max-height: 250px; overflow-y: auto; padding-right: 10px;">
                {% for entry in feedbacks|reverse %}
                <div style="border-bottom: 1px solid #222; padding: 12px 0; font-size: 0.85rem;">
                    <strong>{{ entry.user_name }}</strong> <span style="color:#666">felt</span> <span style="color:var(--accent-red); font-weight:bold;">{{ entry.vibe }}</span> <span style="color:#666">on</span> <em>{{ entry.movie_title }}</em>
                    <p style="margin: 5px 0 0; color: #888; font-style: italic;">"{{ entry.comment|truncate(90) }}"</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="descModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; gap: 30px; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 280px;">
                    <h2 id="descModalTitle" style="color: var(--accent-red); margin-top: 0;"></h2>
                    <p id="descModalText" style="line-height: 1.6; color: #ccc; font-size: 0.9rem;"></p>
                    <button onclick="document.getElementById('descModal').style.display='none'" style="background:#333; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:10px;">Close Analysis</button>
                </div>
                <div style="width: 250px; text-align: center;">
                    <div style="height: 220px; width: 220px; margin: 0 auto;">
                        <canvas id="individualPulseChart"></canvas>
                    </div>
                    <small style="color:#555; text-transform:uppercase; letter-spacing:1px; margin-top:10px; display:block;">Resonance breakdown</small>
                </div>
            </div>
        </div>
    </div>

    <div id="feedbackModal" class="modal">
        <div class="modal-content" style="max-width: 380px;">
            <h3 id="modalMovieTitle" style="color: var(--accent-red); margin: 0 0 15px; border-bottom: 1px solid #333; padding-bottom: 10px;"></h3>
            <form action="{{ url_for('submit_feedback') }}" method="POST">
                <input type="hidden" name="movie_title" id="hiddenMovieTitle">
                
                <label style="font-size: 0.7rem; color: #888; display: block; margin-bottom: 5px; font-weight:bold;">CHOOSE VIBE</label>
                <select name="vibe" class="form-input" required>
                    <option value="Mind-Blowing">Mind-Blowing ü§Ø</option>
                    <option value="Heartwarming">Heartwarming ‚ù§Ô∏è</option>
                    <option value="Tear-Jerker">Tear-Jerker üò¢</option>
                    <option value="Edge-of-Seat">Edge-of-Seat ‚ö°</option>
                    <option value="Pure-Joy">Pure-Joy üòä</option>
                    <option value="Thought-Provoking">Thought-Provoking ü§î</option>
                </select>

                <label style="font-size: 0.7rem; color: #888; display: block; margin-bottom: 5px; font-weight:bold;">SCORE (1-10)</label>
                <input type="number" name="rating" min="1" max="10" value="8" class="form-input">

                <textarea name="comment" placeholder="What's the vibe?" required class="form-input" style="height: 70px; resize: none;"></textarea>

                <button type="submit" style="background: var(--accent-red); color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer;">Post Pulse</button>
                <button type="button" onclick="document.getElementById('feedbackModal').style.display='none'" style="background:none; border:none; color:#555; width:100%; margin-top:10px; cursor:pointer; font-size:0.8rem;">Cancel</button>
            </form>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 <strong>CinemaPulse</strong>. All Rights Reserved.</p>
        <p>Designed and Developed by <span style="color: #888;">Cinemapulse org</span></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 1. Individual Doughnut Chart Logic
        async function openAnalysisModal(element) {
            const title = element.getAttribute('data-title');
            document.getElementById('descModalTitle').innerText = title;
            document.getElementById('descModalText').innerText = element.getAttribute('data-desc');
            document.getElementById('descModal').style.display = 'block';

            try {
                const response = await fetch(`/api/radar-comparison?m1=${encodeURIComponent(title)}`);
                const result = await response.json();
                
                const ctx = document.getElementById('individualPulseChart').getContext('2d');
                const existing = Chart.getChart("individualPulseChart");
                if (existing) existing.destroy();

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mind-Blowing', 'Heartwarming', 'Tear-Jerker', 'Edge-of-Seat', 'Pure-Joy', 'Thought-Provoking'],
                        datasets: [{
                            data: result.datasets[0].data,
                            backgroundColor: ['#e50914', '#ff69b4', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6'],
                            borderWidth: 0, cutout: '78%'
                        }]
                    },
                    options: { plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false }
                });
            } catch (e) { console.error("Chart Error:", e); }
        }

        // 2. Feedback Modal Logic
        function openFeedback(title) {
            document.getElementById('modalMovieTitle').innerText = title;
            document.getElementById('hiddenMovieTitle').value = title;
            document.getElementById('feedbackModal').style.display = 'block';
        }
    </script>
</body>
</html>