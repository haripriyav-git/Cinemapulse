<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CinemaPulse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/movies.css') }}">
    <style>
        :root { --accent-red: #e50914; --card-bg: #1a1a1a; --text-gray: #aaa; }
        body { background-color: #0d0d0d; color: white; font-family: 'Poppins', sans-serif; margin: 0; overflow-x: hidden; }
        
        .hero-banner { 
            height: 40vh; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; background: linear-gradient(to bottom, rgba(0,0,0,0.7), #0d0d0d), 
            url('https://images.unsplash.com/photo-1478720568477-152d9b164e26?q=80&w=2070'); 
            background-size: cover; background-position: center; 
        }
        .hero-banner h1 span { color: var(--accent-red); }
        .main-content { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section-header { border-left: 4px solid var(--accent-red); padding-left: 15px; margin-bottom: 30px; }

        /* Audience Pulse Graph Styling */
        .pulse-container { 
            background: #121212; border-radius: 12px; border: 1px solid #333; 
            margin-bottom: 40px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .pulse-header { padding: 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .vibe-tag-display { background: rgba(229, 9, 20, 0.1); color: var(--accent-red); padding: 6px 16px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; transition: 0.3s; }
        
        /* Movie Grid */
        .placeholder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 30px; }
        .movie-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid #222; transition: 0.3s ease; }
        .movie-card:hover { border-color: var(--accent-red); transform: translateY(-10px); }
        .poster-box { position: relative; height: 320px; cursor: pointer; }
        .bg-poster { width: 100%; height: 100%; object-fit: cover; }
        .rank-badge { position: absolute; top: 10px; left: 10px; background: var(--accent-red); padding: 5px 12px; border-radius: 5px; font-weight: bold; }
        
        .movie-info { padding: 15px; }
        .badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; background: rgba(255, 255, 255, 0.1); color: var(--accent-red); border: 1px solid rgba(229, 9, 20, 0.3); text-transform: uppercase; }

        /* Vibe Colors */
        .dot { height: 12px; width: 12px; border-radius: 50%; flex-shrink: 0; display: inline-block; margin-right: 8px; }
        .mind-blowing { background: #e50914; }
        .heartwarming { background: #ff69b4; }
        .tear-jerker { background: #3498db; }
        .edge-seat { background: #f1c40f; }
        .pure-joy { background: #2ecc71; }
        .thought-provoking { background: #9b59b6; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); }
        .modal-content { background: var(--card-bg); margin: 8% auto; padding: 30px; width: 90%; max-width: 500px; border-radius: 12px; border: 1px solid #333; }
        .submit-btn { background: var(--accent-red); color: white; border: none; padding: 12px; cursor: pointer; border-radius: 5px; width: 100%; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="hero-banner">
        <h1>Your Cinema<span>Pulse</span></h1>
        <p>Visualizing your emotional journey through film.</p>
    </div>

    <div class="main-content">
        <div class="pulse-container">
            <div class="pulse-header">
                <div>
                    <h4 style="color: var(--text-gray); margin: 0; text-transform: uppercase; letter-spacing: 2px; font-size: 0.7rem;">Live Audience Pulse</h4>
                    <h2 id="current-movie" style="margin: 5px 0; font-size: 1.8rem;">Overall Vibe</h2>
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                        <span id="current-vibe" class="vibe-tag-display">Awaiting Hover...</span>
                        <span id="current-rating" style="color: #ffdd57; font-weight: bold; font-size: 1.2rem;">--/10</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <span style="display: block; font-size: 0.7rem; color: #666; text-transform: uppercase;">Trending</span>
                    <span id="top-vibe" style="color: var(--accent-red); font-weight: bold; font-size: 1.3rem;">Analyzing...</span>
                </div>
            </div>
            <div style="height: 350px; padding: 20px; background: #0d0d0d;">
                <canvas id="audiencePulseChart"></canvas>
            </div>
        </div>

        <div style="margin-bottom: 40px;">
            <div class="mood-options" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button class="mood-btn" onclick="filterVibe('Mind-Blowing', this)" style="background: #222; color: white; border: 1px solid #444; padding: 10px 20px; border-radius: 30px; cursor: pointer;">Mind-Blowing</button>
                <button class="mood-btn reset active" onclick="filterVibe('all', this)" style="background: var(--accent-red); color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer;">View All</button>
            </div>
        </div>

        <div class="section-header">
            <h2>Trending <span style="font-weight: 300;">Pulses</span></h2>
        </div>

        <div class="placeholder-grid" id="movieGrid">
            {% for movie in movies %}
            <div class="movie-card" data-vibes="{{ movie.vibe }}">
                <div class="poster-box" onclick="openFeedback('{{ movie.title }}')">
                    <img src="{{ movie.img }}" class="bg-poster" alt="{{ movie.title }}">
                    <div class="rank-badge">#{{ movie.rank }}</div>
                </div>
                <div class="movie-info">
                    <h3>{{ movie.title }}</h3>
                    <div class="details">{{ movie.year }} ‚Ä¢ ‚≠ê {{ movie.rating }}</div>
                    <div class="movie-badges">
                        <span class="badge">{{ movie.lang }}</span>
                        <span class="badge">{{ movie.genre }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <h2 id="modalMovieTitle" style="color: var(--accent-red);"></h2>
            <form action="{{ url_for('submit_feedback') }}" method="POST">
                <input type="hidden" name="movie_title" id="hiddenMovieTitle">
                <input type="number" name="rating" min="1" max="10" placeholder="Rating (1-10)" required style="width:100%; padding:10px; margin-bottom:15px; background:#222; border:1px solid #444; color:white;">
                <select name="vibe" required style="width:100%; padding:10px; margin-bottom:15px; background:#222; border:1px solid #444; color:white;">
                    <option value="Mind-Blowing">Mind-Blowing ü§Ø</option>
                    <option value="Heartwarming">Heartwarming ‚ù§Ô∏è</option>
                    <option value="Tear-Jerker">Tear-Jerker üò¢</option>
                    <option value="Edge-of-Seat">Edge-of-Seat ‚ö°</option>
                    <option value="Pure-Joy">Pure Joy üòä</option>
                    <option value="Thought-Provoking">Thought-Provoking ü§î</option>
                </select>
                <textarea name="comment" rows="3" placeholder="Tell us more..." style="width:100%; padding:10px; background:#222; border:1px solid #444; color:white;"></textarea>
                <button type="submit" class="submit-btn">Post Pulse</button>
                <button type="button" onclick="closeFeedback()" class="close-btn" style="width:100%; margin-top:10px; background:#333; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // CHART LOGIC
        async function initPulseChart() {
            try {
                const response = await fetch('/api/global-pulse');
                const data = await response.json();
                if (!data.length) return;

                const vibeColors = {
                    'Mind-Blowing': '#e50914', 'Heartwarming': '#ff69b4',
                    'Tear-Jerker': '#3498db', 'Edge-of-Seat': '#f1c40f',
                    'Pure-Joy': '#2ecc71', 'Thought-Provoking': '#9b59b6'
                };

                const ctx = document.getElementById('audiencePulseChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            data: data.map(d => d.score),
                            borderColor: '#e50914',
                            backgroundColor: 'rgba(229, 9, 20, 0.1)',
                            fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        onHover: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const i = activeElements[0].index;
                                const entry = data[i];
                                document.getElementById('current-movie').innerText = entry.movie;
                                document.getElementById('current-vibe').innerText = entry.vibe;
                                document.getElementById('current-rating').innerText = `${entry.raw_rating}/10`;
                                
                                const color = vibeColors[entry.vibe] || '#e50914';
                                document.getElementById('current-vibe').style.color = color;
                                document.getElementById('current-vibe').style.backgroundColor = color + '22';
                            }
                        },
                        scales: { 
                            y: { min: 0, max: 100, display: false },
                            x: { grid: { display: false }, ticks: { color: '#444' } }
                        }
                    }
                });

                // Calculate Top Vibe
                const counts = {};
                data.forEach(d => counts[d.vibe] = (counts[d.vibe] || 0) + 1);
                const topVibe = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                document.getElementById('top-vibe').innerText = topVibe;

            } catch (err) { console.error("Chart failed:", err); }
        }

        // FEEDBACK FUNCTIONS
        function openFeedback(title) {
            document.getElementById('modalMovieTitle').innerText = title;
            document.getElementById('hiddenMovieTitle').value = title;
            document.getElementById('feedbackModal').style.display = 'block';
        }
        function closeFeedback() { document.getElementById('feedbackModal').style.display = 'none'; }

        window.onload = initPulseChart;
    </script>
</body>
</html>